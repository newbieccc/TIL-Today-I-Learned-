# # UNIX 시스템

## 08. 파일 시스템 관리

- 컴퓨터과학과 김희천 교수님

### (1) 마운트와 언마운트

- 마운트
    - 파일 시스템을 전체 디렌터리 구조에서 특정 디렉터리에 연결하는 것
        - 저장 장치에 파티션이 존재하며, 파티션에 파일 시스템을 만들어져 있음
    - 마운트 되는 위치를 마운트 지점이라 함
- /etc/fstab 파일
    - 리눅스 시스템이 부팅될 때 자동으로 마운트 할 파일 시스템의 목록을 가진 설정 파일
        - 각 라인마다 개별 파일 시스템의 마운트 정보가 기록되어 있음
    - 라인을 구성하는 항목의 의미

| 필드           | 내용                                                                             |
|--------------|--------------------------------------------------------------------------------|
| 디바이스         | 장치의 이름으로 디바이스 파일(예: `/dev/sda1`) 또는 UUID(Universally Unique Identifier)가 사용됨   |
| 마운트 지점       | 파일 시스템 트리에서 디바이스가 부착되는 위치(디렉터리)                                                |
| 파일 시스템 유형    | 리눅스에서 허용하는 파일 시스템의 유형                                                          |
| 옵션           | 마운트 옵션으로 `mount` 명령에서 `-o` 옵션을 사용하는 것과 의미가 같음                                  |
| 덤프 여부        | 백업을 위한 것으로 **0**은 덤프하지 말라는 것, **1**은 하라는 것                                     |
| 파일 시스템 검사 여부 | 파일 시스템 검사를 위한 것으로 **0**은 검사하지 않음. **루트(/)** 파일 시스템은 1일 때, 나머지 파일 시스템은 2일 때 검사함 |

- 마운트와 /etc/fstab 파일
    - UUID는 파일 시스템을 유일하게 구분하는 숫자(32자리 16진수)
        - 블록 디바이스의 정보를 보여주는 blkid 명령 또는 lsblk -f 명령으로 확인할 수 있음
    - 마운트 또는 언마운트를 하면 내용이 /etc/mtab 파일에 기록됨
        - 옵션 없이 단순히 mount 명령을 사용하면 현재 마운트되어 있는 파일 시스템을 보여줌
    - 기본 마운트 옵션(defaults) 은 rw, suid, dev, exec, auto, nouser, async가 적용됨
        - mount 명령에서 옵션 -o를 사용할 때 적용할 수 있음
- mount 명령(1)
    - 파일 시스템을 마운트하는 명령
        - 파일 시스템을 지정된 디렉터리(마운트 지점)에 붙여 파일 시스템을 사용할 수 있게 함
    - mount -a[options][-t type]
        - 옵션 -a는 /etc/fstab 파일에 기록된 모든 파일 시스템을 마운트 함
        - 옵션 -t가 추가되면 해당 유형의 파일 시스템만 마운트 함
    - mount[options][-o mount_options] device | directory
        - -a가 사용되지 않으면 지정된 장치(또는 디렉터리)에 해당하는 것을 찾아 마운트 함
        - 옵션 -o는 파일 시스템을 마운트 할 때 사용할 옵션
    - 예
        - mount -a -t iso9660
        - /etc/fstab에 나열된 iso9660 유형의 모든 파일 시스템을 마운트
- mount 명령(2)
    - mount /dev/cdrom 또는 mount/mnt/cdrom
        - 장치명 또는 마운트 포인트만 명시되면 /etc/fstab에서 해당 파일 시스템을 찾아 마운트
    - 다음은 /etc/fstab 파일과 무관한 일반적 마운트 방법임
    - mount [options][-t type][-o mount_options] device directory
        - mount 명령을 실행하기 전에 마운트 지점(디렉터리)를 생성해야 함
        - 해당 장치가 존재하는지, 파일 시스템 유형이 맞는지 확인함
        - 존재한다면 /etc/fstab 파일에서 해당 파티션에 지정된 옵션을 적용하고, 옵션 -o에서 주어진 것을 적용하며, 사용되었다면 -r 또는 -w을 적용함
    - 예
        - mount -t ext4 /dev/sdb1 /mnt/data1
        - mount -t iso9660 -o ro /dev/sr0 /media/cd
        - mount -t vfat /dev/hda3 /mnt/win98
- umount 명령
    - 디렉터리에 마운트 되어 있는 저장 장치를 해당 디렉터리로부터 분리
    - umount -a [-nv][-t]
    - umount [-nv] device | directory
    - 예
        - umount -a -t iso9660
            - /etc/mtab에서 iso9660 유형의 파일 시스템을 모두 언마운트
        - umount /dev/sr0
        - umount /media/usb

### (2) 파티션

- 파티션
    - 물리적 저장 장치를 논리적으로 분할한 고정 크기의 구역
        - 하나의 하드디스크에 여러 개의 파티션을 만들 수 있음
    - 파티션은 자신만의 디바이스 파일을 가짐
        - 하나의 파티션을 독립적 저장 장치처럼 사용할 수 있음
            - 첫 번째 SCSI 디스크는 /dev/sda
            - 그리고 첫 번째 파티션은 /dev/sda1, 두번째 파티션은 /dev/sda2...
    - 전통적 'MBR 유형 파티션 테이블'은 4개의 primary 파티션을 저장할 수 있음
- 디스크를 여러 파티션으로 분할하여 사용하는 이유
    - 멀티 부팅을 위해 여러 운영체제를 별도의 파티션에 설치함
    - 특정 파티션이 손상되더라도 다른 파티션의 데이터는 보존됨
    - 파티션 별로 다른 파일 시스템을 만들 수 있음
    - /boot 영역을 별도의 파티션으로 분리하여 빠르게 부팅함
    - /var 영역을 별도의 파티션으로 만들어 루트(/) 영역의 가용 공간이 줄어드는 문제를 방지함
    - 가상 메모리로 사용될 스왑 영역을 별도의 파티션으로 구성함
- 파티션 관리 도구(1)
    - 파티션과 파티션 테이블을 관리하는 프로그램
        - MBR 유형 파티션 테이블은 파티션의 최대 크기에 제약이 있음
        - 최근 운영체제는 GPT 유형의 파티션 테이블을 지원함
    - 파티션의 생성, 삭제, 이동, 크기 변경 및 복사 기능을 제공
        - 파일 시스템을 관리할 때는 다른 도구를 사용하는 것이 좋음
    - 종류
        - fdisk는 전통적 테스트 기반 대화식 도구로 GPT는 지원하지 않음
        - parted는 MBR과 GPT를 모두 지원
        - gdisk는 GPT를 지원하며, gparted는 parted의 그래픽 버전
- 파티션 관리 도구(2)
    - parted -l 또는 fdisk -l 명령은 모든 블록 디바이스에서 파티션 정보를 보여줌
        - parted /dev/sda를 수행한 후 서브 명령으로 p를 수행할 수 있음
- 파티션 만들기(1)
    - 저장 장치를 실제로 사용하려면 파티션을 만들고, 파일 시스템을 만들어 주어야 함
        - parted 또는 fdisk 명령을 사용하여 파티션을 만들 수 있음
        - 이어서 mkfs 명령으로 파일 시스템을 만듦
    - 연습은 위해 다음 방법을 사용함
        - 가상 머신에 하드디스크를 추가
            - VMware 메인 창에서 [edit virtual machine settings] > 설정 창에서 [add] > 하드웨어 타입에서 'Hard Disk' > [Next] 를 실행
        - 또는 가상 머신에 USB 메모리를 장착
            - 가상 머신 메뉴에서 마운트 할 수 있음
    - 저장 장치의 이름을 알아보기 위해 ls /dev/sd*, parted -l 또는 tail -f /var/log/mesages 명령을 사용할 수 있음

### (3) 볼륨 관리

- 볼륨
    - 볼륨은 크기가 재조정도리 수 있는 파티션
        - 디스크 관리 또는 파티션 관리를 위해 새롭게 등장한 개념
        - 볼륨의 크기를 줄이거나 늘릴 수 있음
    - 여러 디스크를 합쳐 하나의 볼륨을 만들 수 있음
    - 용어
        - 물리 볼륨(PV)은 하나의 물리적 디스크
        - 볼륨 그룹(VG)은 여러 물리 볼륨을 하나로 묶은 것으로 가상의 하드디스크
        - 논리 볼륨(LV)은 볼륨 그룹에서 가용한 공간을 분할한 것으로 개념적으로 기존 파티션과 일치함
        - 물리 볼륨은 물리 익스텐트(PE)로 나누어져 있으며, 논리 볼륨은 (LE)로 나누어짐
- 논리 볼륨 만들기
    - 하드디스크에서 파티션을 만듦
    - 하드디스크의 파티션을 물리 볼륨(pv)으로 만듦
    - 하나 이상의 물리 볼륨(pv)을 묶어서 볼륨 그룹(vf)을 만듦
    - 볼륨 그룹(vg) 안에서 논리 볼륨(lv)을 생성
    - 논리 볼륨(lv)에 파일 시스템을 생성하고 마운트하여 사용
- LVM 유틸리티(1)
    - 볼륨 관리 도구
    - 여러 저장 장치에 각각 물리 볼륨을 만들고, 이것을 합쳐 볼륨 그룹(저장 장치 풀)을 구축
    - 볼륨 그룹을 여러 논리 봄륨들로 나누어 사용

### (4) 파일 시스템

- 파일 시스템
    - 저장 장치를 디렉터리 구조로 조직화하고 파일에 이름을 부여하는 등의 파일의 저장과 검색을 위한 체계
        - 파일에 파일명과 경로를 부여하여 저장이나 검색을 위해 파일을 구분하고 식별하기 위한 방법을 제공
    - 파일 시스템의 종류에 따라 파일 시스템의 크기, 파일 이름의 길이, 파일의 크기, 파일의 총 개수, 파일의 복구, 성능/보안/유연성 등에 차이가 남
- 파일 시스템의 구조(1)
    - 유닉스 계열의 운영체제에서 사용하는 파일 시스템의 기본 구성 요소
        - 하드디스크
            - MBR / 파티션1 / 파티션2/ 파티션3
        - 파티션
            - 부트 블록 / 슈퍼 블록 / inode 테이블 / 데이터 블록
        - inode 테이블
            - inode 번호 / 데이터 블록 번호 / 메타 데이터
        - 데이터 블록
- 파일 시스템의 구조(2)
    - 슈퍼 블록
        - 파일 시스템의 특징을 기록한 블록
        - 블록의 크기, 전체 블록의 개수, inode 테이블의 크기와 위치, 디스크 블록 맵, 첫 번째 데이터 블록의 주소 등
    - inode 테이블
        - inode 리스트 라고도 함
        - 하나의inode(레코드)는 한 개 파일의 이름을 제외한 모든 정보를 가짐
        - inode 번호, 파일의 형태, 크기, 접근 권한, 소유자, 소유 그룹, 수정 시간, 링크 수, 디스크 블록의 위치 등
        - 디렉터리나 특수 파일도 하나의 파일로 간주됨
    - 데이터 블록
        - 일반 파일의 경우 실제 데이터가 저장됨
        - 디렉터리의 경우 포함된 파일의 이름이 inode 번호와 함께 저장됨
- 파일 시스템 유형
    - 커널이 사용하는 가상 파일 시스템과 네트워크 파일 시스템도 있음

| 파일 시스템    | 설명                                                                                                                           |
|-----------|------------------------------------------------------------------------------------------------------------------------------|
| `ext4`    | 리눅스 전용 파일 시스템으로 범용 파일 시스템. ext2와 ext3의 개선된 버전으로 최대 크기 **1EiB**, 최대 파일 크기 **16TiB**. 저널링을 통한 신뢰성, 온라인 단편화 제거, 하위 호환성 등의 기능 제공 |
| `iso9660` | CD-ROM과 같은 **광학 디스크**에서 사용되는 표준 파일 시스템                                                                                       |
| `vfat`    | **윈도우와 호환**되는 파일 시스템으로 **USB**에서 주로 사용됨                                                                                      |
| `HFS+`    | **맥(매킨토시)**에서 사용되는 표준 파일 시스템                                                                                                 |
| `Btrfs`   | 리눅스의 **차세대 파일 시스템**                                                                                                          |
| `XFS`     | **고성능**으로 대용량 파일(또는 파일 시스템)을 사용하기 위한 파일 시스템                                                                                  |

- mfks 명령
    - 파티션이나 논리 볼륨에 리눅스 파일 시스템을 만드는 명령
    - mkfs [-t fs-type] device
        - 옵션 -t fs-type을 사용하여 파일 시스템의 종류를 지정
        - device는 /dev/sdb1과 같은 파티션의 장치 이름 또는 논리 볼륨의 이름
    - 실제 mkfs 명령은 'mkfs.종류이름'을 사용하여 수행 됨
        - 코드의 재사용을 높이려는 목적으로 기본은 /sbin/mkfs.ext2
- fsck 명령
    - 파일 시스템의 무결성을 검사하고 손상된 파일을 고치는 명령
        - 마운트되어 있지 않은 파일 시스템을 검사
        - 문제가 있다면 대화식으로 파일 시스템을 복원
        - 파일 시스템의 'lost+found' 디렉터리에 손상된 파일이 남아 있을 수 있음
    - fsck [options] device
    - e2fsck와 같은 파일 시스템 고유의 검사 프로그램이 존재할 수 있음
- 스왑 영역
    - 특정 파티션이나 파일을 스왑 영역으로 지정하여 사용할 수 있음
        - 메모리 사용량을 확인하는 free 명령으로 스오바 메모리도 알 수 있음
    - 파티션을 스오바 영역으로 사용할 때
        - 빈 파티션을 만듦
        - mkswap device를 수행하여 스왑 파티션으로 함
            - 지정한 특정 장치나 파일을 리눅스용 스왑 영역으로 지정
        - swapon device를 수행하여 활성화 시킴
            - free 명령으로 스오바 영역의 공간을 확인할 수 있으
        - 부팅할 때마다 사용하려면 /etc/fstab 파일에 기록함
- af 명령
    - 마운트 되어 있는 파일 시스템의 공간 사용 정보를 보여 줌
    - df [options] [names]
        - 인수 names는 장치 이름 또는 마운트 지점
    - df [options] [names]
        - -h는 용량의 단위를 KB, MB, GB 단위로 보여줌
        - -T는 파일 시스템의 유형을 포함하여 출력함
        - -i는 node의 사용량을 보여줌
- du 명령
    - 디렉터리(또는 특정 파일)의 디스크 사용량을 표시하는 명령
    - du [options] [directories]
        - 인수 directories는 특정 파일 또는 디렉터리
        - 기본적으로 하위 디렉터리를 포함하고 1KiB 단위로 출력함
    - 옵션
        - -a는 디렉터리 외에 파일의 디스크 사용량도 출력함
        - -s는 주어진 디렉터리 또는 파일만의 총 사용량을 요양하여 출력함
    - 예
        - 단순 du 명령은 현재 디렉터리와 모든 서브 디렉터리의 사용량을 표시
        - du --max-depth=1 /home은 사용자 별로 디스크 사용량을 표시
