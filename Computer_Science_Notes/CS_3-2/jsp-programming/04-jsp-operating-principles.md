# # JSP프로그래밍

## 04. JSP 동작원리

- 컴퓨터과학과 김희천 교수님

### (1) JSP의 처리 과정

- JSP의 처리과정
    - 클라이언트가 JSP 페이지를 요청하면, 웹 컨테이너가 다음 단계를 수행
    - JSP 페이지의 최초 요청 시
        - 상응하는 서블릿 클래스(.class)가 있는지 확인
        - JSP 파일(.jsp)을 서블릿 자바 소스(.java)로 변환
        - 변환된 서블릿 자바 소스(.java)를 컴파일하여 클래스 파일(.class) 생성
        - 서블릿 클래스(.class)를 실행하여 클라이언트 요청을 처리
    - 이후 요청 시
        - JSP 페이지에 상응하는 서블릿 클래스(.class)이 없거나, 소스가 수정된 경우에만 변환과 컴파일 작업을 수행

- 서블릿 소스와 클래스 파일
    - 배포 후, 번역된 서블릿 프로그램 찾기
        - [톰캣설치폴더]
            - `\work\Catalina\localhost\[프로젝트이름]\org\apache\jsp 폴더에 자바 서블릿 소스와 클래스 파일이 저장됨`
        - 이클립스 작업 공간에서는 아래 폴더에 있음
        - [이클립스작업공간]
            - `\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\work\Catalina\localhost\HelloJSP\org\apache\jsp`

### (2) 출력 버퍼와 응답

- 출력 버퍼
    - 출력 버퍼는 응답 결과의 임시 저장소
        - 응답을 만들 때 먼저 출력 버퍼에 기록함
        - 출력 버퍼 사용 여부와 크기는 page 지시어의 buffer 속성으로 지정함
        - <%@ page buffer="8kb" ...%>
            - page 지시어에서 buffer 속성의 기본값은 8kb
            - buffer="none"이면, 버퍼를 사용하지 않는 것
                - 버퍼에 기록되지 않고 응답이 바로 전송됨
        - 버퍼에 기록된 내용은 JSP 실행이 끝나면 한 번에 클라이언트에 전달됨
            - 버퍼가 가득 찼을 때와 강제 플러쉬 경우도 전송
- 버퍼를 사용하는 이유
    - 데이터 전송 효율 향상
        - 데이터를 모아 한 번에 전송하여 네트워크 부하 감소
    - 응답 내용 변경 가능
        - 실행 도중 버퍼를 비우고 새로운 내용으로 대체 가능
        - 예: 실행 도중 에러 발생 시 에러 페이지로 교체
    - 응답이 전송된 적이 없으면, 버퍼에 있는 헤더 정보 수정 가능
        - 응답 헤더는 응답 몸체보다 먼저 전송되므로, 버퍼가 전송되기 전(커밋 전)에는 변경 가능
            - 이미 전송된 적이 있으면, 전송된 부분은 변경이 불가하므로 헤더 변경은 불가
        - 포워드 또는 에러 페이지로의 교체 여지를 남김
- 버퍼 미사용 시 제약 사항
    - 출력된 결과를 변경할 수 없음
        - 즉시 전송되므로 실행 중 오류 발생 시 이전 결과와 오류 메시지가 뒤섞이게 됨
    - `<jsp:forward>` 사용불가
        - 응답이 커밋되면 포워딩 시도는 예외를 발생시킴
        - 버퍼 미사용 시, `<jsp:forward>` 액션은 응답이 커밋되기 전에만 가능하나, 실제 거의 불가능
    - page 지시어에서 errorPage 속성 사용 불가
        - 오류가 생기면 에러페이지로 포워딩해야 하나, 불가능하기 때문
- page 지시어의 autoFlush 속성
    - true(기본 값)인 경우
        - 버퍼가 가득 차면, 자동으로 플러시(전송)하고 작업을 계속함
            - 응답이 커밋된 후에는 헤더 변경 불가. 포워드와 리다이렉트 불가
        - false인 경우
            - 버퍼가 가득 차면, 예외(IOException) 발생

### (3) JSP서블릿 프로그래밍

- 서블릿 프로그램
    - 자바 기반 서버 측 웹 애플리케이션으로 클라이언트의 HTTP 요청을 처리하고 동적으로 응답을 생성
        - 동적으로 HTML 페이지 생성
        - JDBC를 이용한 데이터베이스 연동
        - 비즈니스 로직 처리
        - JSP와 함께 MVC 패턴 구현
    - 웹 컨테이너 안에서 동작하며, 컨테이너가 서블릿의 생명 주기 관리와 요청/응답 객체 생성을 담당함
- 서블릿 클래스
    - 서블릿 규약을 따르는 자바 클래스
        - Servlet 인터페이스를 직접 구현하거나, 보통은 HttpServlet 클래스를 상속하여 작성
        - 클라이언트로부터 GET 요청이 오면 doGet() 호출, POST 요청이면 doPost() 호출
    - 웹 컨테이너가 서블릿 클래스를 로드하고, 인스턴스를 생성한 후 초기화 작업을 수행하고, 요청을 처리
        - 실제 요청이 들어오면 웹 컨테이너가 서블릿의 생성자, init(), service(), doGet() 또는 doPost() 순으로 실행
- Get 요청
    - 리소스를 조회(읽기)할 때 사용
        - 단순 질의 또는 정적 파일 요청 등
    - 파라미터를 URL 뒤에 쿼리 문자열(?key=value)로 포함시켜 전송하는 방식
        - /search?q=java&lang=ko
        - 길이 제한이 있음
        - 민감 정보를 전송하기에 부적함
    - 파라미터를 포함한 북마크가 가능
        - GET 요청의 결과는 브라우저 캐시에 저장 가능
    - `<a>` 태그 또는 `<form ... method="get">` 태그를 사용할 때 GET 요청 발생
- doGet() 메서드
    - GET 요청이 서블릿에 들어올 때 자동 호출되는 메서드
    - 주요 기능
        - 요청 데이터 읽기
            - request.getParameter("name");
        - 응답 헤더의 작성
            - response.setContentType("text/html;charset=UTF-8"")
        - 출력 스트림 만들기
            - PrinterWriter out = response.getWriter();
        - 출력 스트림을 이용하여 응답을 작성
            - `out.print("<h1>");`
- POST 요청
    - 많은 양의 데이터를 보낼 때 사용
        - 데이터 양에 제한이 없음
        - 파일 업로드, 회원 가입을 위한 요청
    - 파라미터를 요청 몸체에 포함 시켜 보내는 방식
        - URL에 노출되지 않으며 보안상 상대적으로 안전
        - 서버의 데이터를 변경할 때 주로 사용
    - `<form ... method="get">` 일 때 POST 요청 발생
        - 북마크 불가능
- doPost() 메서드
    - 서블릿이 POST 요청을 처리할 때 자동 호출
    - 주요 기능은 doGet()의 경우와 유사
        - HTML 폼 데이터를 읽을 때, request.getParameter("name")
