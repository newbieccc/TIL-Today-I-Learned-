# # JSP프로그래밍

## 08. 쿠키 사용하기

- 컴퓨터과학과 김희천 교수님

### (1) 쿠키 개념과 동작 원리

- 쿠키의 정의
    - 웹 브라우저에 저장되는 작은 크기의 텍스트 데이터
        - `이름=값` 형태로 여러 개 저장 가능
        - 쿠키의 추가 정보(쿠키의 속성)를 붙일 수 있음
            - 유효 시간, 연결할 도메인(서버), 유효 경로 등
- 쿠키의 필요성
    - HTTP의 Stateless 특성: 이전 요청에 대한 정보가 없음
        - 같은 클라이언트인지 식별 불가
        - 쿠키를 통해 상태 정보를 저장했다 전송
            - 동일 사용자 식별 및 살태 유지
        - 로그인 유지, 장바구니, 개인화 서비스 등 상태 유지에 활용
- 쿠키의 처리 과정
    - 쿠키의 생성, 저장 및 전송
        - 클라이언트의 요청과 서버의 응답
            - 서버에서 상태 관리가 필요하면, 서버에서 쿠키 생성 후 응답 헤더에 포함되어 클라이언트로 전송
        - 쿠키 저장
            - 응답을 받은 클라이언트가 쿠키를 브라우저에 저장
        - 이후 클라이언트의 요청
            - 이후 요청시 저장 중인 쿠키를 요청 헤더에 포함하여 서버에 전송
        - 서버의 상태 확인
            - 쿠키 정보를 통해 같은 사용자 임을 확인
                - 여러 요청을 연결하여 처리 가능
            - 사용자를 식별하고 개인화된 서비스 제공
- 쿠키의 생성과 전송
    - JSP 페이지에서 Cookie 클래스의 객체를 생성
    - 쿠키를 전송하기 전에 추가 정보를 설정할 수 있음
    - response.addCookie()를 사용하여 쿠키를 추가
        - set-Cookie 응답 헤더를 추가

```jsp
<%
  Cookie cookie = new Cookie("name", "jimmy");
  cookie.setMaxAge(3600);
  response.addCookie(cookie);
%>
```

| 메서드                         | 리턴타입     | 기능                                                                   |
|-----------------------------|----------|----------------------------------------------------------------------|
| `getName()`                 | `String` | 쿠키의 이름을 반환                                                           |
| `getValue()`                | `String` | 쿠키의 값을 반환                                                            |
| `setValue(String value)`    | `void`   | 쿠키의 값을 `value`로 지정                                                   |
| `setDomain(String pattern)` | `void`   | 쿠키가 전송될 서버의 도메인을 지정                                                  |
| `getDomain()`               | `String` | 지정된 쿠키의 도메인을 반환                                                      |
| `setPath(String uri)`       | `void`   | 쿠키의 전송 경로를 설정                                                        |
| `getPath()`                 | `String` | 설정된 쿠키의 전송 경로를 반환                                                    |
| `setMaxAge(int time)`       | `void`   | 쿠키의 유효시간을 **초 단위**로 설정. 시간을 **음수**로 지정하면 브라우저 종료 시 쿠키가 삭제됨(기본값 `-1`) |
| `getMaxAge()`               | `int`    | 쿠키의 유효 시간을 반환                                                        |

- 쿠키의 유효 시간
    - 브라우저가 쿠키를 저장하는 시간
        - 유효 시간이 경과된 쿠키는 웹 브라우저에서 자동 삭제됨
        - 유효 시간은 브라우저에서만 관리됨
        - 쿠키 생성 후 setMaxAge(int seconds)를 사용하여 지정
            - 양수는 지정된 시간(단위 초)동안 유지
            - 유효 시간을 0으로 지정하면 기존 쿠키를 삭제한다는 의미
            - 유효 시간을 설정하지 않으면 -1(기본값)로 설정되며, 웹 브라우저 종료 시 쿠키가 삭제됨

### (2) 쿠키의 처리와 제어

- 쿠키 값 읽기
    - 서버에서 생성된 쿠키는 브라우저에 전달되어 저장됨
        - 브라우저가 종료되지 않거나 유효시간이 끝나지 않으면, 다음 요청 시 쿠키를 포함하여 서버에 보냄
        - 다른 페이지에서도 쿠키 정보의 공유가 가능
    - request.getCookies()로 클라이언트가 보낸 쿠키 배열을 확인

```jsp
<%
  Cookie[] cookies = request.getCookies();
  if (cookies != null) {
    for (Cookie cookie : cookies) {
      out.println(cookie.getName() + " : " + cookie.getValue());
    }
  }
%>
```

- 쿠키 값 변경과 쿠키 삭제
    - 변경
        - 같은 이름이나 다른 값으로 새로운 쿠키를 생성하여 다시 전송
            - 같은 이름의 기존 쿠키가 갱신됨
            - 전송은 response.addCookie()
        - 이름이 같더라도 도메인이나 경로가 다르면 다른 쿠키로 존재할 수 있음
    - 삭제
        - 삭제하려는 쿠키의 유효시간을 0으로 설정한 후 다시 전송
            - setMaxAge(0)으로 유효시간을 0으로 설정
            - 브라우저가 유효시간이 0인 쿠키를 받으면 즉시 삭제함
- 쿠키의 도메인 설정
    - 요청 시 쿠키의 전송
        - 기본적으로 쿠키는 생성한 즉, 발급한 서버에만 전송됨
            - 다른 호스트(또는 다른 도메인)로는 보내지 않음
            - 예: 쿠키를 발급한 서버가 `www.example.com`이면 그 호스트로만 전송됨(api.example.com으로는 전송 안함)
        - setDomain(".example.com")을 사용하면 모든 하위 도메인에 쿠키 공유 가능
            - 모든 하위 도메인 즉, www.example.com, api.example.com, sub.example.com 등에 모두 쿠키가 발급됨
            - 응답 헤더 예:
                - Set-Cookie: name=jimmy; Domain=.example.com
- 쿠키의 경로 설정
    - 요청을 보낼 때, 쿠키를 보낼 서버 상의 경로를 정하는 것
    - 쿠키의 기본 경로는 쿠키를 생성한 JSP 파일이 위치한 디렉터리의 경로
        - 예: http://localhost:8080/HelloJSP/sbu/test.jsp에서 경로는 /HelloJSP/sub/
    - setPath(String url)를 통해 쿠키가 적용될 경로 지정 가능
        - 쿠키의 전송 범위를 넓히기 위해, 상위 디렉터리로 지정할 수 있음
            - 지정된 경로와 그 하위 폴더에서만 쿠키 전송
        - 예:
            - cookie.setPath("/HelloJSP")
            - response.addCookie(cookie)

### (3) 쿠키를 이용한 로그인 구현

- 쿠키와 로그인
    - HTTP의 stateless 특성
        - 요청과 요청 사이의 사용자 상태를 기억하지 않음
    - 쿠키를 사용하면 서버와 클라이언트 간 사용자 정보 공유 가능
        - 서버가 사용자 식별 정보를 쿠키에 담아 클라이언트에 전달
        - 이후 클라이언트가 같은 웹 사이트에 요청할 때마다, 쿠키를 보냄
    - 로그인/로그아웃 기능 구현 시 쿠키를 활용하여 동일 사용자 여부 확인
        - 서버는 클라이언트가 보낸 쿠키를 이용하여 사용자를 구별
- 쿠키를 이용한 로그인 절차
    - 아이디와 비밀번호를 입력할 수 있는 폼을 제시
    - 사용자가 아이디와 비밀번호를 입력하고 제출
    - 사용자가 입력한 아이디, 비밀번호를 읽고, 가입된 회원인지 판단(회원 인증)
        - 보통 DB를 조회하여 회원 여부를 확인
    - 회원 인증에 성공하면 로그인 상태에서 사용할 쿠키 생성
        - 서버가 쿠키를 발급하여 클라이언트에 전송
    - 이후 요청 시 사용자가 보낸 쿠키를 이용해 로그인 여부 판단
    - 로그아웃을 하면 사용했던 쿠키를 삭제
        - 쿠키의 유효 시간을 0으로 지정
