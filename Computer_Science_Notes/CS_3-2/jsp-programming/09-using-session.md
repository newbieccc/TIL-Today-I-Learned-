# # JSP프로그래밍

## 09. 세션 사용하기

- 컴퓨터과학과 김희천 교수님

### (1) 세션 개념과 동작 원리

- 세션의 정의
    - 웹 서버가 클라이언트별 상태를 유지하기 위해, 웹 컨테이너에 만드는 서버 측 저장 공간
        - 또는 사용자 데이터를 일정 시간 서버에 저장하는 기술
        - 웹 애플리케이션-웹 브라우저별로, 필요할 때 개별 세션이 생성됨
            - 클라이언트 식별을 위해 서버가 부여하는 세션 ID(쿠키) 사용
            - 브라우저를 닫거나 세션 유효시간이 지나면 세션이 만료됨
- 세션과 쿠키의 비교
    - 세션
        - 데이터가 서버에 저장되므로 쿠키보다 보안에 유리
        - 식별을 위해 세션 ID(보통 JSESSIONID)만 쿠키로 전달
        - 객체의 형태로 저장
        - 용량은 서버가 허용하는 한도까지 가능
        - 기본적으로 브라우저 종료 시 삭제
    - 쿠키
        - 사용자 데이터가 클라이언트(브라우저)에 저장
        - 해당 도메인/경로에 매 요청마다 전송
        - 텍스트 형태의 키-값 쌍으로 저장
        - 크기와 개수의 제한
        - 만료 시간 설정 가능
- JSP 세션 생성과 동작 원리
    - 사용자가 웹 서버(컨테이너)에 접속하면 세션이 자동 생성됨
        - 단, page 지시어에서 세션을 비활성화한 경우는 생성되지 않음
        - 웹 컨테이너는 session 객체를 만들고 세셧 아이디를 부여
            - 웹 브라우저당 1개의 세션 아이디 발급
            - 세션이 생성되면 브라우저에 쿠키를 전송하며 응답 헤더에 Set-Cookie:JSESSION=...
                - 기본적으로 브라우저 종료 시 삭제 (Max-Age가 -1)
            - 이후 요청 시 브라우저는 저장된 세션 ID를 요청 헤더에 포함하며, 요청헤더에 Cookie: JSESSIONID=...
            - 서버는 전달받은 세션 ID로 해당 사용자의 세션 상태를 연결
    - JSP에서 session 내장 객체를 통해 세션 정보에 접근 가능

### (2) session 내장 객체

- session 내장 객체
    - 사용자의 세션 정보를 관리하는 데 사용되는 객체
        - <%@page session="true" %>에서 session 객체가 자동 생성
            - page 지시어에서 session 속성의 기본 값은 true
        - 웹 컨테이너가 제공하는 HttpSession 유형 객체
    - session 영역을 관리하는 객체
        - 사용자가 브라우저를 닫거나 세션이 만료될 때 까지 유지됨
        - 세션 정보를 저장하고 조회할 수 있음
            - 세션 아이디, 유효 시간, 생성 시간 등
        - 속성의 저장과 확인
            - setAttribute(String name, Object value)
            - getAttribute(String name)
- HttpSession 인터페이스의 메서드

| 메서드                               | 리턴 타입    | 기능                                                               |
|-----------------------------------|----------|------------------------------------------------------------------|
| `getId()`                         | `String` | 세션별로 고유하게 부여되는 **세션 아이디**를 리턴                                    |
| `getCreationTime()`               | `long`   | 세션이 **생성된 시간**을 리턴. 1970-01-01 00:00:00부터 경과한 **0.001초 단위**의 시간값 |
| `getLastAccessedTime()`           | `long`   | 클라이언트가 해당 세션에 **마지막으로 접근한 시간**을 리턴                               |
| `setMaxInactiveInterval(int sec)` | `void`   | 세션의 **유효 시간(타임아웃 시간)** 을 **초 단위**로 설정                            |
| `invalidate()`                    | `void`   | 세션을 **삭제(무효화)**                                                  |

- 세션 삭제
    - 세션을 유지할 필요가 없을 경우 삭제
    - 세션을 삭제 or 무효화하려면 invalidate()를 사용
        - 기존 세션은 더 이상 유효하지 않음
        - 해당 세션에 저장된 모든 속성도 삭제됨
            - 세션에 저장된 특정 속성만 삭제하려면 removeAttribute(String name)을 사용
        - 사용자가 웹 브라우저를 종료하면 기존 세션이 삭제됨
            - JSESSIONID 쿠키가 삭제되기 때문
        - 웹 브라우저를 종료하지 않더라도 설정된 유효 시간 (세션 타임아웃 시간)이 초과되면 세션이 삭제됨
            - 세션이 생성된 후, 사용자 요청 없이 세션이 유지되는 최대 시간
                - 사용자 활동이 계속되면 세션은 계속 유지됨
- 세션의 유효 시간
    - 클라이언트가 마지막 요청 이후, 추가 요청 없이 세션을 유지시킬 수 있는 최대 시간
    - 유효 시간 설정 방법
        - 프로그램에서 setMaxInactiveInterval(int interval)을 사용
            - 단위는 초, 0 or 음수의 경우 웹 브라우저를 종료하지 않는 한 세션 유지
            - 예: session.setMaxInactiveInterval(60 * 30); // 30분
        - web.xml에 설정
            - 위치는 톰캣설치폴더\conf\ 또는 웹애플리케이션\WEB-INF\
            - `<session-timeout>30</session-timeout>` // 30분 (단위는 분)
- session 객체의 명시적 생성
    - JSP에서 세션은 필요한 경우 자동으로 만들어짐
        - session 객체는 HttpSession 유형의 내장 객체
    - 서블릿 프로그램에서는 session은 내장 객체가 아님
        - 세션 관리가 필요하면 명시적 세션 생성이 필요
    - request.getSession() 또는 request.getSession(false)
        - 기존 세션이 존재하면, 기존 세션 객체를 반환
        - 기존 세션이 없다면
            - getSession()은 세션 객체를 생성하여 리턴함
            - getSession(false)는 새로 만들지 않고 null을 리턴함
        - 서블릿에서 세션이 필요하면 request.getSession()으로 세션을 생성해서 사용해야 함

### (3) 세션을 이용한 로그인/로그아웃 처리

- 세션을 이용한 로그인
    - 로그인 인증
    - 아이디, 비밀번호가 정확하면 session 객체에 로그인 여부 확인을 위한 속성을 저장
        - session.setAttribute("login", "admin")
    - 로그인이 실패한 경우, 로그인 확인 or 로그인 폼으로 안내
- 세션을 이용한 로그아웃
    - 로그인 여부 확인
        - session 객체에 특정 속성이 설정되어 있는지 여부로 확인
            - 여기서는 이름이 "login"인 속성의 값을 확인
            - 해당 속성의 값이 "admin"이면 로그인 한 상태가 됨
            - 먼저 값이 null이 아닌지 검사해야 함
    - 로그아웃 처리
        - 세션 삭제로 구현
        - session.invalidate();
